<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‘½è¿ç»‡å¸ƒæœº - åŒè¯­ç‰ˆ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <style>
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        .animate-twinkle { animation: twinkle 3s infinite ease-in-out; }
        .animate-fade-in-down { animation: fadeInDown 1s ease-out; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
        .animate-fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(139, 92, 246, 0.5); }
    </style>
</head>
<body class="bg-[#0f0c29] text-amber-100 font-sans selection:bg-purple-500/30">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Sparkles, Moon, Sun, RefreshCw, Star, Fingerprint, Loader2, AlertCircle, LayoutGrid, Layers, GitBranch, Globe } from 'lucide-react';

        // --- Configuration ---
        
        // [é‡è¦] è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ Kimi (Moonshot) API Key
        const moonshotApiKey = "sk-RsEuBHKqu5LWBgqJeoEylpajrYXiHqHp7QNRMOGmnDoUtBZv"; 

        const API_BASE_URL = "https://api.moonshot.cn/v1"; 
        const MODEL_NAME = "moonshot-v1-8k";

        // --- Translations ---
        const TRANSLATIONS = {
            zh: {
                title: "AI å‘½è¿ç»‡å¸ƒæœº",
                subtitle: "Oracle of the Digital Void",
                intro_label: "å‘è™šç©ºä½è¯­ä½ çš„å›°æƒ‘...",
                placeholder: "ä¾‹å¦‚ï¼šæˆ‘æœ€è¿‘çš„èŒä¸šå‘å±•å¦‚ä½•ï¼Ÿ",
                start_btn: "å¼€å¯æ³•é˜µ",
                select_spread: "1. é€‰æ‹©ç‰Œé˜µ",
                your_question: "2. ä½ çš„å›°æƒ‘",
                shuffling_click: "ç‚¹å‡»æŠ½å–",
                analyzing: "æ­£åœ¨è¿æ¥è™šç©º...",
                analyzing_desc: "è§£è¯»å‘½è¿çš„çº¹ç†",
                result_question: "æ‚¨çš„é—®é¢˜",
                spread_label: "ç‰Œé˜µæ˜¾ç°",
                interpretation_label: "å‘½è¿è§£æ",
                again_btn: "å†æ¬¡å åœ",
                error_apikey: "API Key æœªé…ç½®ï¼Œåˆ‡æ¢è‡³ç¦»çº¿æ¨¡å¼",
                error_auth: "API Key éªŒè¯å¤±è´¥ (401)ã€‚è¯·æ£€æŸ¥ Key æ˜¯å¦æ­£ç¡®ã€‚",
                error_network: "ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®ã€‚",
                offline_mode: "ç¦»çº¿æ¨¡å¼",
                dev_hint: "å¼€å‘è€…æç¤º: è¯·åœ¨ä»£ç ä¸­é…ç½® API Keyã€‚",
                spreads: {
                    single: { name: "å•å¼ æŒ‡å¼•", desc: "æ¯æ—¥è¿åŠ¿ / ç®€å•æ˜¯é" },
                    trinity: { name: "åœ£ä¸‰è§’", desc: "æ—¶é—´æµ / äº‹æƒ…èµ°å‘" },
                    four_elements: { name: "å…³ç³»/å››è¦ç´ ", desc: "äººé™…å…³ç³» / äº‹æƒ…å…¨è²Œ" },
                    choice: { name: "äºŒé€‰ä¸€", desc: "æŠ‰æ‹© / ä¸¤ä¸ªæ–¹å‘" }
                },
                positions: {
                    single: ['æ ¸å¿ƒæŒ‡å¼•'],
                    trinity: ['è¿‡å»/åŸå› ', 'ç°åœ¨/é˜»ç¢', 'æœªæ¥/ç»“æœ'],
                    four_elements: ['ç°çŠ¶/è‡ªæˆ‘', 'å¯¹æ–¹/æŒ‘æˆ˜', 'å»ºè®®/æ ¸å¿ƒ', 'ç»“æœ/æœªæ¥'],
                    choice: ['å½“å‰çŠ¶æ€', 'é€‰æ‹©Açš„å‘å±•', 'é€‰æ‹©Bçš„å‘å±•', 'é€‰æ‹©Açš„ç»“æœ', 'é€‰æ‹©Bçš„ç»“æœ']
                },
                upright: "æ­£ä½",
                reversed: "é€†ä½",
                pos_prefix: "ä½ç½®"
            },
            en: {
                title: "AI Fate Weaver",
                subtitle: "Oracle of the Digital Void",
                intro_label: "Whisper your query to the void...",
                placeholder: "e.g., How will my career develop?",
                start_btn: "Open the Circle",
                select_spread: "1. Select Spread",
                your_question: "2. Your Query",
                shuffling_click: "Tap to Draw",
                analyzing: "Connecting to the Void...",
                analyzing_desc: "Reading the texture of fate",
                result_question: "Your Query",
                spread_label: "The Spread",
                interpretation_label: "Interpretation",
                again_btn: "Divinate Again",
                error_apikey: "API Key missing, switching to Offline Mode",
                error_auth: "API Key Unauthorized (401). Check your Key.",
                error_network: "Network Error. Check settings.",
                offline_mode: "Offline Mode",
                dev_hint: "Dev Hint: Configure API Key in code.",
                spreads: {
                    single: { name: "Single Card", desc: "Daily Guidance / Yes or No" },
                    trinity: { name: "Trinity", desc: "Time Flow / Situation Path" },
                    four_elements: { name: "Four Elements", desc: "Relationships / Overview" },
                    choice: { name: "Two Choices", desc: "Dilemma / Two Paths" }
                },
                positions: {
                    single: ['Core Guidance'],
                    trinity: ['Past/Cause', 'Present/Obstacle', 'Future/Outcome'],
                    four_elements: ['Current/Self', 'Other/Challenge', 'Advice/Core', 'Result/Future'],
                    choice: ['Current State', 'Path A Growth', 'Path B Growth', 'Path A Result', 'Path B Result']
                },
                upright: "Upright",
                reversed: "Reversed",
                pos_prefix: "Position"
            }
        };

        // --- Data Definitions (Updated with English) ---

        const SPREADS_CONFIG = [
            { id: 'single', count: 1, icon: <Star className="w-4 h-4" /> },
            { id: 'trinity', count: 3, icon: <Layers className="w-4 h-4" /> },
            { id: 'four_elements', count: 4, icon: <LayoutGrid className="w-4 h-4" /> },
            { id: 'choice', count: 5, icon: <GitBranch className="w-4 h-4" /> }
        ];

        const MAJOR_ARCANA = [
            { id: 0, name: "æ„šè€…", nameEn: "The Fool", up: "æ–°çš„å¼€å§‹ã€å†’é™©ã€çº¯çœŸ", upEn: "New beginnings, innocence", rev: "é²è½ã€å†’é™©å¸¦æ¥çš„é£é™©", revEn: "Recklessness, risk-taking", icon: "ğŸ¤¡" },
            { id: 1, name: "é­”æœ¯å¸ˆ", nameEn: "The Magician", up: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›", upEn: "Manifestation, resourcefulness", rev: "æ“çºµã€æ‰èƒ½æœªå‘æŒ¥", revEn: "Manipulation, poor planning", icon: "ğŸª„" },
            { id: 2, name: "å¥³ç¥­å¸", nameEn: "The High Priestess", up: "ç›´è§‰ã€ç¥ç§˜ã€æ½œæ„è¯†", upEn: "Intuition, sacred knowledge", rev: "å‹æŠ‘æƒ…æ„Ÿã€éšè—çš„æ•Œäºº", revEn: "Secrets, disconnected from intuition", icon: "ğŸ“œ" },
            { id: 3, name: "å¥³çš‡", nameEn: "The Empress", up: "ä¸°é¥¶ã€æ¯æ€§ã€è‡ªç„¶", upEn: "Femininity, nature, nurturing", rev: "ä¾èµ–ã€åˆ›é€ åŠ›å—é˜»", revEn: "Creative block, dependence", icon: "ğŸ‘‘" },
            { id: 4, name: "çš‡å¸", nameEn: "The Emperor", up: "æƒå¨ã€ç»“æ„ã€ç¨³å›º", upEn: "Authority, structure", rev: "æš´æ”¿ã€åƒµåŒ–ã€ç¼ºä¹çºªå¾‹", revEn: "Domination, excessive control", icon: "ğŸ°" },
            { id: 5, name: "æ•™çš‡", nameEn: "The Hierophant", up: "ä¼ ç»Ÿã€ç²¾ç¥æŒ‡å¼•", upEn: "Spiritual wisdom, tradition", rev: "æŒ‘æˆ˜ä¼ ç»Ÿã€ç›²ä»", revEn: "Personal beliefs, freedom", icon: "â›ª" },
            { id: 6, name: "æ‹äºº", nameEn: "The Lovers", up: "çˆ±ã€å’Œè°ã€ä»·å€¼è§‚", upEn: "Love, harmony, relationships", rev: "ä¸å’Œè°ã€å¤±è¡¡", revEn: "Disharmony, imbalance", icon: "ğŸ’•" },
            { id: 7, name: "æˆ˜è½¦", nameEn: "The Chariot", up: "èƒœåˆ©ã€æ„å¿—åŠ›", upEn: "Control, willpower, success", rev: "å¤±æ§ã€æ”»å‡»æ€§", revEn: "Lack of control, aggression", icon: "ğŸ›¡ï¸" },
            { id: 8, name: "åŠ›é‡", nameEn: "Strength", up: "å‹‡æ°”ã€è€å¿ƒã€åŒæƒ…å¿ƒ", upEn: "Strength, courage, persuasion", rev: "è½¯å¼±ã€è‡ªæˆ‘æ€€ç–‘", revEn: "Inner weakness, self-doubt", icon: "ğŸ¦" },
            { id: 9, name: "éšå£«", nameEn: "The Hermit", up: "å†…çœã€å­¤ç‹¬ã€å¯»æ±‚çœŸç†", upEn: "Soul-searching, introspection", rev: "å­¤ç«‹ã€è¿·å¤±æ–¹å‘", revEn: "Isolation, withdrawal", icon: "ğŸ•¯ï¸" },
            { id: 10, name: "å‘½è¿ä¹‹è½®", nameEn: "Wheel of Fortune", up: "å¥½è¿ã€è½¬æŠ˜ç‚¹", upEn: "Good luck, karma, destiny", rev: "å„è¿ã€æŠµæŠ—å˜åŒ–", revEn: "Bad luck, resistance to change", icon: "ğŸ¡" },
            { id: 11, name: "æ­£ä¹‰", nameEn: "Justice", up: "å…¬æ­£ã€çœŸç†ã€å› æœ", upEn: "Justice, fairness, truth", rev: "ä¸å…¬ã€ä¸è¯šå®", revEn: "Unfairness, dishonesty", icon: "âš–ï¸" },
            { id: 12, name: "å€’åŠäºº", nameEn: "The Hanged Man", up: "ç‰ºç‰²ã€æ–°è§†è§’ã€ç­‰å¾…", upEn: "Pause, surrender, letting go", rev: "åœæ»ã€æ— è°“çš„ç‰ºç‰²", revEn: "Delays, resistance, stalling", icon: "ğŸ¤¸" },
            { id: 13, name: "æ­»ç¥", nameEn: "Death", up: "ç»“æŸã€è½¬å˜ã€é‡ç”Ÿ", upEn: "Endings, change, transformation", rev: "æŠ—æ‹’æ”¹å˜ã€åœæ»", revEn: "Resistance to change, stagnation", icon: "ğŸ’€" },
            { id: 14, name: "èŠ‚åˆ¶", nameEn: "Temperance", up: "å¹³è¡¡ã€é€‚åº¦ã€è€å¿ƒ", upEn: "Balance, moderation, patience", rev: "å¤±è¡¡ã€è¿‡åº¦", revEn: "Imbalance, excess", icon: "ğŸº" },
            { id: 15, name: "æ¶é­”", nameEn: "The Devil", up: "æŸç¼šã€ç‰©è´¨ä¸»ä¹‰", upEn: "Shadow self, attachment, addiction", rev: "æ‰“ç ´æŸç¼šã€é‡è·è‡ªç”±", revEn: "Releasing limiting beliefs, detachment", icon: "ğŸ˜ˆ" },
            { id: 16, name: "é«˜å¡”", nameEn: "The Tower", up: "çªå˜ã€è§‰é†’ã€ç ´å", upEn: "Sudden change, upheaval, chaos", rev: "é¿å…ç¾éš¾ã€ææƒ§æ”¹å˜", revEn: "Fear of change, averting disaster", icon: "âš¡" },
            { id: 17, name: "æ˜Ÿæ˜Ÿ", nameEn: "The Star", up: "å¸Œæœ›ã€çµæ„Ÿã€å®é™", upEn: "Hope, faith, purpose", rev: "ç»æœ›ã€ç¼ºä¹ä¿¡å¿ƒ", revEn: "Lack of faith, despair", icon: "â­" },
            { id: 18, name: "æœˆäº®", nameEn: "The Moon", up: "å¹»è§‰ã€ææƒ§ã€æ½œæ„è¯†", upEn: "Illusion, fear, subconscious", rev: "é‡Šæ”¾ææƒ§ã€æ¸…æ™°", revEn: "Release of fear, confusion", icon: "ğŸŒ™" },
            { id: 19, name: "å¤ªé˜³", nameEn: "The Sun", up: "å¿«ä¹ã€æˆåŠŸã€æ´»åŠ›", upEn: "Positivity, fun, warmth", rev: "æš‚æ—¶çš„æ¶ˆæ²‰", revEn: "Feeling down, overly optimistic", icon: "â˜€ï¸" },
            { id: 20, name: "å®¡åˆ¤", nameEn: "Judgement", up: "å¤æ´»ã€è§‰é†’ã€å¬å”¤", upEn: "Judgement, rebirth, inner calling", rev: "è‡ªæˆ‘æ€€ç–‘ã€æ‹’ç»å¬å”¤", revEn: "Self-doubt, ignoring the call", icon: "ğŸº" },
            { id: 21, name: "ä¸–ç•Œ", nameEn: "The World", up: "å®Œæˆã€æ•´åˆã€æˆå°±", upEn: "Completion, integration, accomplishment", rev: "æœªå®Œæˆã€ç¼ºä¹é—­ç¯", revEn: "Incompletion, lack of closure", icon: "ğŸŒ" },
        ];

        const SUITS = [
            { key: 'Wands', name: 'æƒæ–', nameEn: 'Wands', icon: 'ğŸ”¥' },
            { key: 'Cups', name: 'åœ£æ¯', nameEn: 'Cups', icon: 'ğŸ·' },
            { key: 'Swords', name: 'å®å‰‘', nameEn: 'Swords', icon: 'ğŸ—¡ï¸' },
            { key: 'Pentacles', name: 'æ˜Ÿå¸', nameEn: 'Pentacles', icon: 'ğŸª™' }
        ];

        const RANKS = [
            { rank: 1, name: 'é¦–ç‰Œ', nameEn: 'Ace', icon: '1ï¸âƒ£', up: 'æ–°æœºä¼š', upEn: 'New opportunity', rev: 'é”™å¤±è‰¯æœº', revEn: 'Missed chance' },
            { rank: 2, name: '2', nameEn: 'Two', icon: '2ï¸âƒ£', up: 'å¹³è¡¡', upEn: 'Balance', rev: 'ä¸å¹³è¡¡', revEn: 'Imbalance' },
            { rank: 3, name: '3', nameEn: 'Three', icon: '3ï¸âƒ£', up: 'åˆä½œ', upEn: 'Collaboration', rev: 'å»¶è¯¯', revEn: 'Delays' },
            { rank: 4, name: '4', nameEn: 'Four', icon: '4ï¸âƒ£', up: 'ç¨³å®š', upEn: 'Stability', rev: 'åœæ»', revEn: 'Stagnation' },
            { rank: 5, name: '5', nameEn: 'Five', icon: '5ï¸âƒ£', up: 'å†²çª', upEn: 'Conflict', rev: 'è§£å†³å†²çª', revEn: 'Resolution' },
            { rank: 6, name: '6', nameEn: 'Six', icon: '6ï¸âƒ£', up: 'å’Œè°', upEn: 'Harmony', rev: 'æ²‰æººè¿‡å»', revEn: 'Stuck in past' },
            { rank: 7, name: '7', nameEn: 'Seven', icon: '7ï¸âƒ£', up: 'é€‰æ‹©', upEn: 'Choices', rev: 'çŠ¹è±«', revEn: 'Indecision' },
            { rank: 8, name: '8', nameEn: 'Eight', icon: '8ï¸âƒ£', up: 'æŒæ¡', upEn: 'Mastery', rev: 'ç¼ºä¹é‡ç‚¹', revEn: 'Lack of focus' },
            { rank: 9, name: '9', nameEn: 'Nine', icon: '9ï¸âƒ£', up: 'æ»¡è¶³', upEn: 'Fulfillment', rev: 'ä¸æ»¡è¶³', revEn: 'Dissatisfaction' },
            { rank: 10, name: '10', nameEn: 'Ten', icon: 'ğŸ”Ÿ', up: 'åœ†æ»¡', upEn: 'Completion', rev: 'æœªå®Œæˆ', revEn: 'Broken family' },
            { rank: 11, name: 'ä¾ä»', nameEn: 'Page', icon: 'ğŸ‘¶', up: 'æ–°æ¶ˆæ¯', upEn: 'New ideas', rev: 'åæ¶ˆæ¯', revEn: 'Bad news' },
            { rank: 12, name: 'éª‘å£«', nameEn: 'Knight', icon: 'ğŸ', up: 'è¡ŒåŠ¨', upEn: 'Action', rev: 'é²è½', revEn: 'Recklessness' },
            { rank: 13, name: 'çš‡å', nameEn: 'Queen', icon: 'ğŸ‘¸', up: 'å…³æ€€', upEn: 'Nurturing', rev: 'ä¾èµ–', revEn: 'Dependence' },
            { rank: 14, name: 'å›½ç‹', nameEn: 'King', icon: 'ğŸ¤´', up: 'æŒæ§', upEn: 'Authority', rev: 'æš´æ”¿', revEn: 'Tyranny' },
        ];

        const generateMinorArcana = () => {
            let deck = [];
            let idCounter = 22;
            SUITS.forEach(suit => {
                RANKS.forEach(rank => {
                    deck.push({
                        id: idCounter++,
                        name: `${suit.name}${rank.name}`,
                        nameEn: `${rank.nameEn} of ${suit.nameEn}`,
                        up: `${rank.up}`,
                        upEn: `${rank.upEn}`,
                        rev: `${rank.rev}`,
                        revEn: `${rank.revEn}`,
                        icon: rank.rank > 10 ? `${suit.icon}${rank.icon}` : suit.icon, 
                        isMajor: false
                    });
                });
            });
            return deck;
        };

        const TAROT_DECK = [...MAJOR_ARCANA, ...generateMinorArcana()];

        // --- Logic Helper ---
        const generateOfflineReading = (question, cards, spreadId, lang) => {
            const t = TRANSLATIONS[lang];
            const spreadConfig = t.spreads[spreadId];
            const positions = t.positions[spreadId];
            
            let reading = lang === 'zh' 
                ? `(ç¦»çº¿æ¨¡å¼)\né’ˆå¯¹é—®é¢˜ï¼šâ€œ${question}â€ï¼Œç‰Œé˜µã€${spreadConfig.name}ã€‘çš„è§£è¯»å¦‚ä¸‹ï¼š\n\n`
                : `(Offline Mode)\nFor question: "${question}", Spread [${spreadConfig.name}] Reading:\n\n`;
            
            cards.forEach((c, i) => {
                const posName = positions[i] || `${t.pos_prefix} ${i+1}`;
                const cardName = lang === 'zh' ? c.card.name : c.card.nameEn;
                const posDesc = c.isUpright ? t.upright : t.reversed;
                const meaning = lang === 'zh' 
                    ? (c.isUpright ? c.card.up : c.card.rev)
                    : (c.isUpright ? c.card.upEn : c.card.revEn);
                
                reading += `${i+1}. ${posName}: ã€${cardName}ã€‘(${posDesc})\n${meaning}\n\n`;
            });
            
            reading += lang === 'zh' 
                ? "ç»¼åˆæŒ‡å¼•ï¼šè¯·ç»“åˆè¿™äº›ç‰Œæ„ï¼Œè·Ÿéšæ‚¨çš„ç›´è§‰è¡ŒåŠ¨ã€‚"
                : "Guidance: Combine these meanings and follow your intuition.";
            
            return reading;
        };

        function TarotApp() {
            const [lang, setLang] = useState('zh'); // 'zh' or 'en'
            const t = TRANSLATIONS[lang];
            
            const [gameState, setGameState] = useState('intro');
            const [question, setQuestion] = useState('');
            const [selectedSpreadId, setSelectedSpreadId] = useState('trinity'); 
            
            const [currentDeck, setCurrentDeck] = useState(TAROT_DECK);
            const [displayCardIndex, setDisplayCardIndex] = useState(0);
            const [drawnCards, setDrawnCards] = useState([]);
            const [interpretation, setInterpretation] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            
            const shuffleIntervalRef = useRef(null);

            const getSpreadConfig = (id) => {
                const staticConf = SPREADS_CONFIG.find(s => s.id === id);
                const textConf = t.spreads[id];
                return { ...staticConf, ...textConf };
            };

            const currentSpread = getSpreadConfig(selectedSpreadId);

            useEffect(() => {
                if (gameState === 'shuffling' && drawnCards.length < currentSpread.count && currentDeck.length > 0) {
                    shuffleIntervalRef.current = setInterval(() => {
                        setDisplayCardIndex(Math.floor(Math.random() * currentDeck.length));
                    }, 83);
                } else {
                    clearInterval(shuffleIntervalRef.current);
                }
                return () => clearInterval(shuffleIntervalRef.current);
            }, [gameState, drawnCards.length, currentDeck.length, currentSpread.count]);

            const callLLM = async (q, cards, spreadId) => {
                const spreadConf = getSpreadConfig(spreadId);
                const posList = t.positions[spreadId];

                if (!moonshotApiKey) {
                    setErrorMsg(t.error_apikey);
                    return generateOfflineReading(q, cards, spreadId, lang);
                }

                const cardDescriptions = cards.map((c, i) => {
                    const posName = posList[i] || `${t.pos_prefix} ${i+1}`;
                    const name = lang === 'zh' ? c.card.name : c.card.nameEn;
                    const orientation = c.isUpright ? t.upright : t.reversed;
                    const meaning = lang === 'zh' 
                        ? (c.isUpright ? c.card.up : c.card.rev)
                        : (c.isUpright ? c.card.upEn : c.card.revEn);
                    return `${i+1}. [${posName}]: ${name} (${orientation}) - ${meaning}`;
                }).join('\n');

                let systemPrompt = "You are a mysterious Tarot reader.";
                let userPrompt = "";

                if (lang === 'zh') {
                    systemPrompt = "ä½ æ˜¯ä¸€ä½ç¥ç§˜çš„å¡”ç½—ç‰Œå åœå¤§å¸ˆã€‚";
                    userPrompt = `ä½ æ˜¯ä¸€ä½ç¥ç§˜çš„å¡”ç½—å åœå¸ˆã€‚
ä½¿ç”¨ç‰Œé˜µï¼šã€${spreadConf.name}ã€‘ã€‚
ç”¨æˆ·é—®é¢˜ï¼š"${q}"ã€‚
æŠ½ç‰Œç»“æœï¼š
${cardDescriptions}

è¯·è¿›è¡Œæ·±åº¦è§£è¯»ã€‚è¯­æ°”ç¥ç§˜ä¼˜é›…ï¼Œå¸¦æœ‰æ–‡å­¦è‰²å½©ã€‚
è¯·é’ˆå¯¹æ¯ä¸ªä½ç½®çš„ç‰Œæ„è¿›è¡Œåˆ†æï¼Œæœ€åç»™å‡ºç»¼åˆå»ºè®®ã€‚
ä¸è¦ä½¿ç”¨Markdownæ ¼å¼ï¼Œç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ã€‚`;
                } else {
                    systemPrompt = "You are a mysterious and insightful Tarot reader.";
                    userPrompt = `You are a mysterious Tarot reader.
Spread used: [${spreadConf.name}].
User Question: "${q}".
Cards Drawn:
${cardDescriptions}

Please provide a deep interpretation. Tone should be mysterious, elegant, and literary.
Analyze the meaning of each card in its position, and provide a comprehensive conclusion.
Do not use Markdown formatting, output plain text only. Please answer in English.`;
                }

                const payload = {
                    model: MODEL_NAME,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: 0.7
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/chat/completions`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${moonshotApiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 401) {
                        setErrorMsg(t.error_auth);
                        return generateOfflineReading(q, cards, spreadId, lang);
                    }
                    
                    if (!response.ok) {
                        const errText = await response.text();
                        setErrorMsg(`API Error: ${response.status}`);
                        return generateOfflineReading(q, cards, spreadId, lang);
                    }

                    const data = await response.json();
                    let text = data.choices?.[0]?.message?.content;
                    if (text) {
                        setErrorMsg(""); 
                        return text.replace(/\*\*/g, '').replace(/###/g, '').replace(/#/g, '');
                    }
                    throw new Error("No content");
                } catch (error) {
                    console.error(error);
                    setErrorMsg(t.error_network);
                    return generateOfflineReading(q, cards, spreadId, lang);
                }
            };

            const handleScreenClick = async () => {
                if (gameState !== 'shuffling' || currentDeck.length === 0) return;

                const currentCard = currentDeck[displayCardIndex];
                if (!currentCard) return;

                const p = Math.floor(Math.random() * 101);
                const isUpright = (Math.floor(Math.random() * 101)) < p;

                const newCard = { card: currentCard, pValue: p, isUpright: isUpright, id: Date.now() };
                const newDrawnCards = [...drawnCards, newCard];
                
                setDrawnCards(newDrawnCards);
                setCurrentDeck(currentDeck.filter(c => c.id !== currentCard.id));
                setDisplayCardIndex(0);

                if (newDrawnCards.length === currentSpread.count) {
                    setGameState('analyzing');
                    const result = await callLLM(question, newDrawnCards, selectedSpreadId);
                    setInterpretation(result);
                    setGameState('result');
                }
            };

            const resetGame = () => {
                setQuestion('');
                setDrawnCards([]);
                setInterpretation('');
                setCurrentDeck(TAROT_DECK);
                setGameState('intro');
                setErrorMsg('');
            };

            const displayCard = currentDeck[displayCardIndex] || TAROT_DECK[0];

            return (
                <div className="min-h-screen w-full overflow-hidden relative">
                    {/* Background */}
                    <div className="fixed inset-0 z-0 pointer-events-none bg-gradient-to-br from-[#0f0c29] via-[#302b63] to-[#24243e]">
                        <div className="absolute top-0 left-0 w-full h-full opacity-30 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-purple-900 via-transparent to-transparent animate-pulse"></div>
                        {[...Array(20)].map((_, i) => (
                        <div key={i} className="absolute rounded-full bg-white animate-twinkle" style={{top: `${Math.random()*100}%`, left: `${Math.random()*100}%`, width: `${Math.random()*3}px`, height: `${Math.random()*3}px`, animationDelay: `${Math.random()*5}s`}} />))}
                    </div>

                    {/* Language Toggle */}
                    <div className="absolute top-4 right-4 z-50">
                        <button 
                            onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
                            className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur text-sm text-purple-200 transition-all"
                        >
                            <Globe className="w-4 h-4" />
                            <span>{lang === 'zh' ? 'English' : 'ä¸­æ–‡'}</span>
                        </button>
                    </div>

                    {/* Main Game UI */}
                    <div className="relative z-10 flex flex-col items-center justify-center min-h-screen p-4">
                        {/* Header */}
                        <header className="mb-6 text-center animate-fade-in-down">
                            <div className="flex items-center justify-center gap-2 mb-2">
                                <Moon className="w-6 h-6 text-purple-400" />
                                <h1 className="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-purple-200 to-amber-200 tracking-wider drop-shadow-[0_0_10px_rgba(255,215,0,0.5)]">
                                    {t.title}
                                </h1>
                                <Sun className="w-6 h-6 text-amber-400" />
                            </div>
                            <p className="text-purple-300 text-sm tracking-widest uppercase opacity-80">{t.subtitle}</p>
                        </header>

                        {/* Intro */}
                        {gameState === 'intro' && (
                            <div className="w-full max-w-md p-6 bg-black/40 backdrop-blur-md border border-purple-500/30 rounded-2xl shadow-[0_0_30px_rgba(88,28,135,0.4)] transform transition-all hover:scale-[1.01]">
                                {!moonshotApiKey && (
                                    <div className="mb-4 p-2 bg-yellow-900/40 border border-yellow-600/50 rounded flex gap-2 items-center text-xs text-yellow-200">
                                        <AlertCircle className="w-4 h-4 flex-shrink-0" />
                                        <span>{t.dev_hint}</span>
                                    </div>
                                )}
                                
                                <div className="mb-6">
                                    <label className="block text-sm text-purple-200 mb-2 font-bold tracking-wide">{t.select_spread}</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {SPREADS_CONFIG.map(conf => {
                                            const spreadInfo = t.spreads[conf.id];
                                            return (
                                                <button
                                                    key={conf.id}
                                                    onClick={() => setSelectedSpreadId(conf.id)}
                                                    className={`p-3 rounded-lg border text-left transition-all ${selectedSpreadId === conf.id ? 'bg-purple-900/60 border-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.2)]' : 'bg-slate-900/40 border-white/10 hover:bg-slate-800'}`}
                                                >
                                                    <div className="flex items-center gap-2 text-amber-100 font-bold text-sm mb-1">
                                                        {conf.icon} {spreadInfo.name}
                                                    </div>
                                                    <div className="text-[10px] text-purple-300 opacity-80 leading-tight">{spreadInfo.desc}</div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="mb-8">
                                    <label className="block text-sm text-purple-200 mb-2 font-bold tracking-wide">{t.your_question}</label>
                                    <input type="text" value={question} onChange={(e) => setQuestion(e.target.value)} placeholder={t.placeholder} className="w-full bg-slate-900/80 border-b-2 border-purple-600 text-center text-amber-100 p-3 focus:outline-none focus:border-amber-400 transition-colors placeholder-slate-600 rounded-t-md" />
                                </div>

                                <button onClick={() => { if(!question.trim()) return; setGameState('shuffling'); }} disabled={!question} className={`w-full py-4 px-6 rounded-lg font-bold text-lg tracking-widest flex items-center justify-center gap-2 transition-all duration-300 ${question ? 'bg-gradient-to-r from-purple-800 to-indigo-900 hover:from-purple-700 hover:to-indigo-800 text-amber-200 shadow-[0_0_15px_rgba(168,85,247,0.5)] border border-purple-500/50' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}>
                                    <Sparkles className="w-5 h-5" /> {t.start_btn}
                                </button>
                            </div>
                        )}

                        {/* Shuffling */}
                        {gameState === 'shuffling' && (
                            <div className="flex flex-col items-center w-full max-w-4xl">
                                <div onClick={handleScreenClick} className="relative group cursor-pointer w-64 h-96 sm:w-72 sm:h-[28rem] perspective-1000 mb-12 select-none touch-manipulation">
                                    <div className="absolute -inset-4 bg-purple-600/20 rounded-full blur-xl animate-pulse"></div>
                                    <div className="relative w-full h-full bg-slate-900 border-2 border-amber-500/70 rounded-xl flex flex-col items-center justify-center shadow-[0_0_30px_rgba(251,191,36,0.2)] transform transition-transform group-active:scale-95 overflow-hidden">
                                        <div className="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-amber-500 to-transparent"></div>
                                        <div className="border border-amber-500/30 m-2 absolute inset-0 rounded-lg"></div>
                                        <div className="z-10 text-center animate-pulse">
                                            <div className="text-6xl mb-4 filter drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">{displayCard.icon}</div>
                                            <h2 className="text-2xl font-serif text-amber-100 tracking-wider px-2">{lang === 'zh' ? displayCard.name : displayCard.nameEn}</h2>
                                            <p className="text-purple-300 text-xs mt-2 uppercase tracking-[0.2em]">{displayCard.isMajor === false ? (lang === 'zh'?'å°é˜¿å¡çº³':'Minor Arcana') : (lang === 'zh'?'å¤§é˜¿å¡çº³':'Major Arcana')}</p>
                                        </div>
                                        <div className="absolute bottom-6 text-xs text-amber-400/60 animate-bounce">{t.shuffling_click} ({drawnCards.length + 1}/{currentSpread.count})</div>
                                    </div>
                                </div>
                                
                                <div className="flex flex-wrap justify-center gap-3 w-full max-w-4xl px-2">
                                    {Array.from({ length: currentSpread.count }).map((_, i) => {
                                        const cardData = drawnCards[i];
                                        return (
                                            <div key={i} className={`relative rounded-lg border border-white/10 flex flex-col items-center justify-center bg-black/20 backdrop-blur-sm transition-all duration-500 w-20 h-28 sm:w-24 sm:h-36
                                                ${cardData ? 'shadow-[0_0_15px_rgba(251,191,36,0.2)] border-amber-500/40' : 'opacity-30 border-dashed'}
                                            `}>
                                                <div className="absolute -top-2 text-[9px] bg-slate-800 px-1.5 py-0.5 rounded border border-slate-600 text-slate-300 z-20 whitespace-nowrap max-w-full overflow-hidden text-ellipsis">
                                                    {t.positions[selectedSpreadId][i] || `#${i+1}`}
                                                </div>
                                                
                                                {cardData ? (
                                                    <div className={`text-center p-1 animate-fade-in-up w-full h-full flex flex-col items-center justify-center ${!cardData.isUpright ? 'rotate-180' : ''}`}>
                                                        <div className="text-2xl mb-1">{cardData.card.icon}</div>
                                                        <div className="text-[8px] sm:text-[10px] text-amber-100 leading-tight line-clamp-2 scale-90">{lang === 'zh' ? cardData.card.name : cardData.card.nameEn}</div>
                                                    </div>
                                                ) : (<div className="text-white/20 text-xl font-serif">?</div>)}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Analyzing */}
                        {gameState === 'analyzing' && (
                            <div className="flex flex-col items-center justify-center animate-fade-in">
                                <div className="relative"><div className="absolute -inset-4 bg-purple-500/30 rounded-full blur-xl animate-pulse"></div><Loader2 className="w-16 h-16 text-amber-200 animate-spin relative z-10" /></div>
                                <p className="mt-8 text-xl text-purple-200 font-serif tracking-widest animate-pulse">{t.analyzing}</p>
                                <p className="mt-2 text-sm text-slate-400">{t.analyzing_desc}</p>
                            </div>
                        )}

                        {/* Result */}
                        {gameState === 'result' && (
                            <div className="w-full max-w-5xl animate-fade-in bg-slate-900/80 backdrop-blur-xl border border-purple-500/30 rounded-2xl overflow-hidden shadow-2xl flex flex-col md:flex-row h-[80vh] md:h-[700px]">
                                {/* Left: Card Summary */}
                                <div className="md:w-1/3 bg-black/30 p-4 border-b md:border-b-0 md:border-r border-white/10 overflow-y-auto">
                                    <div className="mb-4">
                                        <div className="text-xs text-purple-400 uppercase tracking-widest mb-1">{t.result_question}</div>
                                        <div className="text-amber-100 font-serif italic">"{question}"</div>
                                        <div className="mt-2 text-[10px] bg-purple-900/40 inline-block px-2 py-1 rounded text-purple-200 border border-purple-500/20">{currentSpread.name}</div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {drawnCards.map((data, idx) => (
                                            <div key={idx} className="flex items-center gap-3 p-2 rounded hover:bg-white/5 transition-colors">
                                                <div className={`w-10 h-14 rounded border border-amber-500/30 flex items-center justify-center bg-indigo-950 text-lg flex-shrink-0 ${!data.isUpright ? 'rotate-180' : ''}`}>{data.card.icon}</div>
                                                <div className="min-w-0">
                                                    <div className="text-[10px] text-slate-400 mb-0.5">{t.positions[selectedSpreadId][idx]}</div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-amber-200 text-sm truncate">{lang === 'zh' ? data.card.name : data.card.nameEn}</span>
                                                    </div>
                                                    <span className={`text-[9px] px-1.5 rounded-full inline-block mt-1 ${data.isUpright ? 'bg-green-900/40 text-green-300' : 'bg-red-900/40 text-red-300'}`}>{data.isUpright ? t.upright : t.reversed}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Right: AI Interpretation */}
                                <div className="md:w-2/3 p-6 flex flex-col h-full relative">
                                    <h4 className="text-purple-400 text-sm tracking-widest uppercase mb-4 flex items-center gap-2 flex-shrink-0">
                                        <Fingerprint className="w-4 h-4" /> {t.interpretation_label}
                                    </h4>
                                    
                                    {errorMsg && (
                                        <div className="mb-4 p-3 bg-red-900/30 border border-red-500/50 rounded text-xs text-red-200 flex gap-2 flex-shrink-0">
                                            <AlertCircle className="w-4 h-4 flex-shrink-0" />
                                            <div>{errorMsg}</div>
                                        </div>
                                    )}

                                    <div className="flex-grow overflow-y-auto pr-2">
                                        <div className="prose prose-invert prose-p:text-slate-300 prose-strong:text-amber-200 text-sm leading-relaxed whitespace-pre-line">
                                            {interpretation}
                                        </div>
                                    </div>
                                    
                                    <div className="pt-4 mt-4 border-t border-white/10 flex-shrink-0">
                                        <button onClick={resetGame} className="py-3 w-full border border-purple-500/50 rounded hover:bg-purple-900/30 text-purple-200 transition-colors flex items-center justify-center gap-2 text-sm uppercase tracking-wider">
                                            <RefreshCw className="w-4 h-4" /> {t.again_btn}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<TarotApp />);
    </script>
</body>
</html>
